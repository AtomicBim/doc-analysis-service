# Двухшаговый процесс анализа документации

## 📋 Обзор

Приложение работает в 2 этапа для более контролируемого процесса анализа:

1. **Шаг 1**: Извлечение и редактирование требований из ТЗ
2. **Шаг 2**: Анализ проектной документации по подтвержденным требованиям

---

## 🎯 Шаг 1: Извлечение требований

### Что происходит:

1. Пользователь загружает **Техническое задание** (PDF, PDF-картинка или DOCX)
2. Backend извлекает текст через:
   - Прямое чтение текстового слоя (для PDF с текстом)
   - OCR через OpenAI Vision API (для PDF-изображений)
   - Чтение DOCX структуры
3. GPT сегментирует текст на отдельные требования
4. Требования отображаются в **модальном редакторе**

### Возможности редактора:

- ✅ **Выбор требований**: чекбоксы для каждого требования
- ✏️ **Редактирование**: возможность изменить текст любого требования
- 🔢 **Счетчик**: показывает сколько требований выбрано
- ✓ **Кнопка "Выбрать все"**: быстрый выбор/снятие всех галочек

### API endpoint:

```
POST /api/extract_requirements
```

**Параметры:**
- `tz_document`: File (PDF или DOCX)

**Ответ:**
```json
{
  "success": true,
  "total_requirements": 25,
  "requirements": [
    {
      "number": 1,
      "text": "Текст требования",
      "section": "Архитектура",
      "trace_id": "req-1",
      "selected": true
    }
  ]
}
```

---

## 🔍 Шаг 2: Анализ проекта

### Что происходит:

1. Пользователь **подтверждает** отредактированные требования
2. Интерфейс переключается на **Шаг 2**
3. Пользователь выбирает:
   - **Стадию проекта** (ГК, ФЭ, ЭП)
   - **Проектную документацию** (PDF)
4. Backend анализирует проект по выбранным требованиям
5. Результаты отображаются в списке с цветовой индикацией

### Этапы анализа:

1. **Stage 1**: Извлечение метаданных страниц (штампы, заголовки)
2. **Stage 2**: Оценка релевантности страниц для каждого требования
3. **Stage 3**: Детальный анализ релевантных страниц в высоком разрешении
4. **Stage 4**: Поиск противоречий в документации (опционально)

### API endpoint:

```
POST /api/analyze
```

**Параметры:**
- `stage`: string (ГК/ФЭ/ЭП)
- `requirements_json`: JSON string с требованиями из шага 1
- `doc_document`: File (PDF проектной документации)

**Ответ:**
```json
{
  "stage": "ФЭ",
  "req_type": "ТЗ",
  "requirements": [
    {
      "number": 1,
      "requirement": "Текст требования",
      "status": "Полностью исполнено",
      "confidence": 95,
      "solution_description": "Описание решения",
      "reference": "Лист АР-03",
      "discrepancies": "-",
      "recommendations": "-",
      "section": "Архитектура",
      "trace_id": "req-1"
    }
  ],
  "summary": "Статистика анализа..."
}
```

---

## 🎨 Интерфейс

### Индикатор шагов

```
┌─────────────────┐         ┌─────────────────┐
│  ✓ Извлечение   │  ───>   │  2 Анализ       │
│  требований     │         │  проекта        │
└─────────────────┘         └─────────────────┘
```

- **Шаг 1**: Загрузка ТЗ и редактирование требований
- **Шаг 2**: Загрузка проекта и выполнение анализа

### Модальное окно RequirementEditor

Появляется после извлечения требований:

```
┌──────────────────────────────────────────────┐
│  📋 Проверьте извлеченные требования         │
│  ──────────────────────────────────────────  │
│  ☑ Выбрать все (23/25)                       │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │ ☑ #1  Высота потолков 2.64м           │ │
│  │       [Архитектура]                    │ │
│  │       ✎ Редактировать                  │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  [Отмена]  [✓ Подтвердить (23 требований)] │
└──────────────────────────────────────────────┘
```

---

## 📂 Структура файлов

### Backend (Python)

```
api-service/
├── analysis_api_hybrid.py  # Основной API
│   ├── /extract_requirements    # Шаг 1: извлечение
│   └── /analyze                  # Шаг 2: анализ
└── config.py                     # Конфигурация
```

### Frontend (React/TypeScript)

```
ui-react-service/src/
├── App.tsx                       # Управление workflow
├── components/
│   ├── Header.tsx                # Переключение шагов
│   ├── RequirementEditor.tsx     # Редактор требований
│   ├── RequirementList.tsx       # Список результатов
│   └── PdfViewer.tsx             # Просмотр PDF
└── types.ts                      # TypeScript типы
```

---

## 🔄 Управление состоянием (App.tsx)

```typescript
// Шаг процесса
const [currentStep, setCurrentStep] = useState<1 | 2>(1);

// Шаг 1: Извлеченные требования
const [extractedRequirements, setExtractedRequirements] = useState<EditableRequirement[] | null>(null);
const [showRequirementEditor, setShowRequirementEditor] = useState(false);

// Шаг 2: Подтвержденные требования
const [confirmedRequirements, setConfirmedRequirements] = useState<EditableRequirement[] | null>(null);

// Результаты анализа
const [requirements, setRequirements] = useState<Requirement[]>([]);
const [summary, setSummary] = useState<string>('');
```

---

## 🚀 Типичный сценарий использования

### Пример 1: Успешный анализ

1. **Загрузка ТЗ**
   - Пользователь выбирает файл `TZ_Project_2024.pdf`
   - Нажимает "📋 Извлечь требования из ТЗ"
   - Ожидание 10-30 секунд

2. **Редактирование требований**
   - Открывается модальное окно с 28 требованиями
   - Пользователь снимает галочки с 3 нерелевантных требований
   - Редактирует текст 2 требований для уточнения
   - Нажимает "✓ Подтвердить и продолжить (25 требований)"

3. **Анализ проекта**
   - Автоматический переход к Шагу 2
   - Пользователь выбирает стадию "ФЭ"
   - Загружает `Project_Documentation.pdf`
   - Нажимает "🔍 Выполнить анализ проекта"
   - Ожидание 3-10 минут

4. **Просмотр результатов**
   - Список из 25 требований с цветовой индикацией
   - Клик на требование → переход к соответствующему листу PDF
   - Просмотр общей сводки
   - При необходимости: "🔄 Начать заново"

### Пример 2: Отмена редактирования

1. Загрузка ТЗ → извлечение требований
2. В модальном окне пользователь видит некорректные требования
3. Нажимает "Отмена"
4. Может загрузить другой файл ТЗ

---

## 🎯 Преимущества двухшагового подхода

### ✅ Контроль качества
- Пользователь проверяет извлеченные требования
- Возможность исправить ошибки распознавания
- Выбор только релевантных требований

### ⚡ Оптимизация
- Анализируются только выбранные требования
- Меньше времени на анализ
- Ниже стоимость API вызовов

### 📊 Гибкость
- Разные ТЗ для одного проекта
- Один проект под разные наборы требований
- Итеративный подход к анализу

### 🔄 Повторяемость
- Кнопка "Начать заново" для нового анализа
- Сохраненные требования для повторного использования
- История изменений требований

---

## 🛠️ Настройка и конфигурация

### Backend (config.py)

Все параметры анализа настраиваются через `config.py`:

```python
# Stage 1: Метаданные
STAGE1_MAX_PAGES = 150
STAGE1_DPI = 120
STAGE1_QUALITY = 75

# Stage 2: Релевантность
STAGE2_MAX_PAGES = 100
STAGE2_DETAIL = "high"

# Stage 3: Детальный анализ
STAGE3_BATCH_SIZE = 10
STAGE3_MAX_COMPLETION_TOKENS = 8000

# Stage 4: Противоречия
STAGE4_ENABLED = True
```

### Frontend (package.json)

Proxy для API запросов:

```json
{
  "proxy": "http://localhost:8002"
}
```

---

## 📝 API Endpoints Summary

### 1. Health Check
```
GET /
```
Возвращает статус сервиса и информацию о конфигурации

### 2. Extract Requirements (Шаг 1)
```
POST /extract_requirements
Content-Type: multipart/form-data

Parameters:
  - tz_document: File

Response: 200 OK
{
  "success": true,
  "total_requirements": N,
  "requirements": [...]
}
```

### 3. Analyze Documentation (Шаг 2)
```
POST /analyze
Content-Type: multipart/form-data

Parameters:
  - stage: string
  - requirements_json: string (JSON)
  - doc_document: File

Response: 200 OK
{
  "stage": "ФЭ",
  "req_type": "ТЗ",
  "requirements": [...],
  "summary": "..."
}
```

---

## 🐛 Обработка ошибок

### Шаг 1: Извлечение требований

**Проблема**: Не удалось распознать текст
- **Причина**: PDF содержит только изображения без текстового слоя
- **Решение**: Используется OCR через OpenAI Vision API

**Проблема**: Извлечено 0 требований
- **Причина**: Документ не содержит структурированных требований
- **Решение**: Сообщение пользователю, предложение изменить формат ТЗ

### Шаг 2: Анализ проекта

**Проблема**: Не выбрано ни одно требование
- **Причина**: Пользователь снял все галочки
- **Решение**: Кнопка "Подтвердить" недоступна

**Проблема**: Превышен лимит API
- **Причина**: Слишком много страниц или требований
- **Решение**: Автоматическое разбиение на батчи, повторные попытки

---

## 🎓 Технические детали

### Форматы ТЗ

| Формат | Извлечение текста | OCR | Примечание |
|--------|-------------------|-----|------------|
| PDF (текст) | ✅ Прямое чтение | ❌ Не требуется | Быстро |
| PDF (изображение) | ❌ Нет текстового слоя | ✅ Vision API | Медленнее |
| DOCX | ✅ Структура документа | ❌ Не требуется | Поддержка таблиц |

### Оптимизация производительности

- **Текстовый префильтр** на Stage 2 для отсева нерелевантных страниц
- **Батчевая обработка** для больших документов
- **Кэширование метаданных** страниц
- **Параллельная обработка** групп требований

---

## 📊 Метрики и статистика

После анализа отображается:

- Общее количество требований
- Полностью исполнено: N (X%)
- Частично исполнено: N (X%)
- Не исполнено: N (X%)
- Требует уточнения: N (X%)
- Средняя достоверность: X%

---

## 🔮 Будущие улучшения

- [ ] Сохранение сессий анализа
- [ ] Экспорт результатов в Excel/PDF
- [ ] История изменений требований
- [ ] Сравнение разных версий проекта
- [ ] Групповые операции над требованиями
- [ ] Шаблоны требований для разных типов проектов

---

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи backend: `docker logs doc_analysis_api`
2. Проверьте консоль браузера (F12)
3. Убедитесь что OPENAI_API_KEY установлен
4. Проверьте доступность API через `/` endpoint

---

Создано: 2025-10-10
Версия: 2.0.0

