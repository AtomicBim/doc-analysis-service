# Система анализа проектной документации

## Описание проекта

Система автоматического анализа строительной проектной документации, предназначенная для проверки соответствия проектных решений требованиям технического задания (ТЗ) и технических условий (ТУ). Приложение использует искусственный интеллект на базе OpenAI GPT-4 для анализа текстовых и графических материалов чертежей, обеспечивая быструю проверку соответствия проектной документации установленным требованиям.

Система применяется на различных этапах проектирования:
- Градостроительная концепция (ГК)
- Форэскизный проект (ФЭ) 
- Эскизный проект (ЭП)

## Архитектура

Приложение состоит из двух основных компонентов:

### 1. API-сервис (api-service)
- **Технологии:** FastAPI, PyMuPDF, OpenAI Vision API, Docker
- **Функции:**
  - Загрузка и обработка PDF-документов
  - Извлечение текста и графических элементов из чертежей
  - Анализ соответствия требований ТЗ/ТУ проектным решениям
  - Обработка с использованием Vision API для анализа чертежей
  - Гибридный подход: ручной парсинг ТЗ/ТУ + анализ чертежей через AI

### 2. Веб-интерфейс (ui-service)
- **Технологии:** Gradio, requests
- **Функции:**
  - Пользовательский интерфейс для загрузки документов
  - Настройка параметров анализа
  - Отображение результатов в табличном виде
  - Генерация отчетов

## Технологии

### Backend (API-сервис)
- **Python 3.11** - основной язык программирования
- **FastAPI** - фреймворк для создания API
- **PyMuPDF** - библиотека для работы с PDF-файлами
- **OpenAI API** - для анализа документов и извлечения информации
- **Pillow** - обработка изображений
- **Tenacity** - управление повторными попытками запросов
- **Uvicorn** - ASGI-сервер для запуска приложения

### Frontend (UI-сервис)
- **Gradio** - фреймворк для создания веб-интерфейса
- **Requests** - HTTP-клиент для взаимодействия с API

### Инфраструктура
- **Docker** - контейнеризация приложения
- **Docker Compose** - оркестрация сервисов
- **SOCKS-прокси** - для работы с OpenAI API (при необходимости)

## Основные модули и функции

### API-сервис (analysis_api_hybrid.py)

#### Основные функции:
- `extract_pdf_pages_as_images()` - извлекает страницы PDF как изображения для Vision API
- `extract_page_metadata()` - извлекает метаданные страниц (штампы, заголовки)
- `assess_page_relevance()` - определяет релевантные страницы для каждого требования
- `analyze_batch_with_high_detail()` - детальный анализ требований с высоким качеством изображений
- `extract_text_from_pdf()` - извлекает текст из PDF с использованием OCR при необходимости
- `segment_requirements()` - сегментирует ТЗ на отдельные требования
- `classify_requirements_into_batches()` - группирует требования для эффективного анализа

#### Поддерживаемые форматы:
- PDF (до 40 МБ)
- Поддержка OCR для сканированных документов

#### Стадии анализа:
1. **Извлечение метаданных** - анализ штампов, заголовков и структуры документа
2. **Оценка релевантности** - определение страниц, содержащих информацию по каждому требованию
3. **Детальный анализ** - сравнение требований с проектными решениями

### UI-сервис (gradio_ui.py)

#### Основные функции:
- `create_interface()` - создание пользовательского интерфейса
- `process_documentation_analysis()` - обработка файлов и взаимодействие с API
- `format_analysis_results()` - форматирование результатов в табличный вид

#### Пользовательский интерфейс включает:
- Загрузку файлов ТЗ и проектной документации
- Выбор стадии проектирования
- Опциональную проверку ТУ
- Отображение результатов в виде таблицы с детальной информацией

### Система промптов (prompts/)

#### Структура папки:
- `gk_prompt.txt` - промпт для анализа Градостроительной концепции
- `fe_prompt.txt` - промпт для анализа Форэскизного проекта
- `ep_prompt.txt` - промпт для анализа Эскизного проекта
- `tu_fe.txt` и `tu_ep.txt` - предзагруженные технические условия

#### Структура промптов:
- `<задача>` - описание задачи анализа
- `<критерии_оценки>` - критерии оценки выполнения требований
- `<дополнительные_указания>` - инструкции для детального анализа

## Статусы исполнения требований

Система оценивает выполнение требований по следующим критериям:
- **Полностью исполнено** - требование реализовано в полном объёме согласно ТЗ
- **Частично исполнено** - реализовано не полностью или с отклонениями
- **Не исполнено** - не отражено в проектных решениях
- **Требует уточнения** - недостаточно данных для однозначной оценки

## Установка и запуск

### Требования
- Docker
- Docker Compose
- Доступ к API OpenAI (ключ API)

### Установка

1. Склонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd doc-analysis-service
   ```

2. Создайте файл `.env` в директории `api-service` на основе примера:
   ```bash
   cp api-service/.env.example api-service/.env
   ```

3. Укажите в `.env` файле:
   - `OPENAI_API_KEY` - ключ API OpenAI
   - `OPENAI_MODEL` - используемая модель (по умолчанию `gpt-4o`)

4. (Опционально) Настройте SOCKS-прокси в `docker-compose.yml` при необходимости

### Запуск

Запустите приложение с помощью Docker Compose:

```bash
docker-compose up --build
```

После запуска:
- API-сервис будет доступен по адресу `http://localhost:8002`
- Веб-интерфейс будет доступен по адресу `http://localhost:7861`

### Использование

1. Откройте веб-интерфейс по адресу `http://localhost:7861`
2. Загрузите файлы:
   - Техническое задание (ТЗ)
   - Проектная документация (PDF)
   - (Опционально) Технические условия (ТУ)
3. Выберите стадию проектирования (ГК, ФЭ, ЭП)
4. Отметьте опцию проверки ТУ при необходимости
5. Нажмите "Выполнить анализ"
6. Дождитесь завершения анализа и ознакомьтесь с результатами

## Конфигурация

### Параметры API-сервиса

В файле `.env` можно настроить следующие параметры:

- `OPENAI_MODEL` - модель OpenAI для анализа (по умолчанию `gpt-4o`)
- `TEMPERATURE` - температура модели (по умолчанию `0.1` для детерминированных результатов)
- `MAX_FILE_SIZE_MB` - максимальный размер файла (по умолчанию `40` МБ)

### Параметры прокси (при необходимости)

В `docker-compose.yml` настроены переменные прокси:
- `HTTPS_PROXY` и `HTTP_PROXY` - адрес SOCKS-прокси (если используется)
- `NO_PROXY` - исключения для внутренних соединений

## Схема архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                    Веб-интерфейс (Gradio)                   │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │ Загрузка файлов │────│ Параметры анализа (стадия, ТУ)  │ │
│  │ ТЗ, PDF         │    │                                 │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
└──────────────┬──────────────────────────────────────────────┘
               │ HTTP-запрос
               ▼
┌─────────────────────────────────────────────────────────────┐
│                    API-сервис (FastAPI)                     │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │          Гибридный анализ документов                    ││
│  │                                                         ││
│  │  ┌─────────────┐   ┌──────────────────────────────────┐││
│  │  │ Извлечение  │──▶│  Сегментация требований из ТЗ    │││
│  │  │ метаданных  │   └──────────────────────────────────┘││
│  │  └─────────────┘                                       ││
│  │                                                         ││
│  │  ┌─────────────────────────────────────────────────────┐││
│  │  │ Оценка релевантности страниц для требований         │││
│  │  └─────────────────────────────────────────────────────┘││
│  │                                                         ││
│  │  ┌─────────────────────────────────────────────────────┐││
│  │  │ Детальный анализ с использованием Vision API        │││
│  │  └─────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
               ┌─────────────────────────┐
               │   OpenAI API (GPT-4o)   │
               │        Vision API       │
               └─────────────────────────┘
```

## Безопасность

- API-ключ OpenAI хранится в защищенном `.env` файле
- В Docker-контейнерах используется read-only доступ к `.env` файлу
- Временные файлы автоматически удаляются после анализа
- Проверка размера файлов для предотвращения атак

## Мониторинг и логирование

- Все операции логируются с подробной информацией
- Статусы выполнения отслеживаются на каждом этапе
- Обработка ошибок с детализированными сообщениями
- Healthcheck endpoints для мониторинга состояния сервисов

## Разработка

### Добавление новых стадий

Для добавления новой стадии проектирования:
1. Создайте новый файл промпта в директории `prompts/`
2. Добавьте его в маппинг в функции `load_prompts()`
3. Обновите UI-интерфейс при необходимости

### Изменение промптов

Промпты можно редактировать в директории `prompts/`. Изменения вступят в силу после перезапуска API-сервиса.

## Масштабирование

Система разработана с учетом возможностей масштабирования:
- Контейнерная архитектура позволяет легко масштабировать
- Отдельные сервисы могут быть масштабированы независимо
- Поддержка batch-обработки для эффективного использования ресурсов

## Лицензия

[Укажите лицензию проекта при наличии]

## Авторы

[Укажите информацию об авторах проекта при наличии]