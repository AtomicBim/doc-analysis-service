# Система анализа проектной документации

## Описание проекта

Система автоматического анализа строительной документации на соответствие требованиям технического задания (ТЗ) и технических условий (ТУ) с использованием искусственного интеллекта. 

Проект представляет собой гибридное решение, которое:
- Рассматривает ТЗ/ТУ как текстовые документы с последующей сегментацией требований
- Анализирует проектную документацию (чертежи) с помощью Vision API
- Сопоставляет требования с проектными решениями
- Выдает детализированный отчет о соответствии/несоответствии

## Архитектура

Система состоит из двух основных компонентов:

### 1. API-сервис (api-service)
- **Технология**: FastAPI
- **Функция**: Обработка запросов на анализ, интеграция с OpenAI API, выполнение анализа документации
- **Порты**: 8000 (внутри контейнера), 8002 (внешний)

### 2. UI-сервис (ui-service)
- **Технология**: Gradio
- **Функция**: Веб-интерфейс для загрузки документов и отображения результатов
- **Порты**: 7861 (внутри контейнера), 7861 (внешний)

## Технологии

### Backend (api-service)
- **Python 3.11** - основной язык программирования
- **FastAPI** - веб-фреймворк для создания API
- **OpenAI API** - для анализа чертежей с использованием Vision API
- **PyMuPDF** - для работы с PDF-документами
- **Pillow** - для обработки изображений
- **Tenacity** - для повторных попыток при ошибках API
- **Uvicorn** - ASGI-сервер для запуска приложения

### Frontend (ui-service)
- **Python 3.11** - основной язык программирования
- **Gradio** - фреймворк для создания веб-интерфейса
- **Requests** - для взаимодействия с API

### Инфраструктура
- **Docker** - контейнеризация сервисов
- **Docker Compose** - оркестрация контейнеров
- **SOCKS прокси** - для доступа к OpenAI API через VPN

## Принципы работы

### Поддерживаемые стадии проектирования
- **ГК** - Градостроительная концепция
- **ФЭ** - Форэскизный проект
- **ЭП** - Эскизный проект

### Поддерживаемые форматы документов
- **PDF** - для проектной документации
- **DOCX** - для технических заданий и условий

## Стадии анализа

Система реализует 4-ступенчатый процесс анализа, каждый из которых можно настроить через конфигурационные параметры в файле `api-service/config.py`.

### STAGE 1: Извлечение метаданных страниц
Этап предназначен для извлечения метаданных из штампов, заголовков и других ключевых областей страниц документации. На этой стадии система определяет тип, раздел и номер листа для каждой страницы.

**Функции:**
- Определение типа, раздела и номера листа для каждой страницы
- Анализ штампов и заголовков документов
- Извлечение ключевых областей страниц (штамп, правый верхний угол, заголовок)

**Конфигурационные параметры:**
- `STAGE1_MAX_PAGES` (по умолчанию: 150) — максимальное количество страниц для извлечения метаданных
- `STAGE1_DPI` (по умолчанию: 120) — качество рендеринга для вырезок (повышено для лучшей читаемости штампов)
- `STAGE1_QUALITY` (по умолчанию: 75) — JPEG качество для вырезок (оптимально для OCR мелкого текста)
- `STAGE1_MAX_PAGES_PER_REQUEST` (по умолчанию: 30) — максимальное количество страниц метаданных в одном запросе (оптимизировано для ограничения токенов в минуту)

**Области извлечения (проценты от размера страницы):**
- `STAGE1_STAMP_CROP`: {'left': 0.7, 'top': 0.8, 'right': 1.0, 'bottom': 1.0} — правый нижний угол (штамп документации)
- `STAGE1_TOP_RIGHT_CROP`: {'left': 0.7, 'top': 0.0, 'right': 1.0, 'bottom': 0.15} — правый верхний угол
- `STAGE1_HEADER_CROP`: {'left': 0.0, 'top': 0.0, 'right': 1.0, 'bottom': 0.1} — заголовки и названия листов

### STAGE 2: Оценка релевантности страниц
На этой стадии система сопоставляет требования из ТЗ с соответствующими страницами документации и выбирает минимальный набор страниц для дальнейшего анализа. Используется высокое разрешение для точности определения релевантности, особенно при использовании дешевых моделей.

**Функции:**
- Сопоставление требований с соответствующими страницами документации
- Выбор минимального набора страниц для анализа
- Оптимизация для дешевых моделей (например, gpt-4o-mini)

**Конфигурационные параметры:**
- `STAGE2_MAX_PAGES` (по умолчанию: 100) — максимальное количество страниц для оценки релевантности
- `STAGE2_DPI` (по умолчанию: 120) — качество рендеринга (повышено для точности с дешевой моделью)
- `STAGE2_QUALITY` (по умолчанию: 85) — JPEG качество (высокое, т.к. модель дешевая)
- `STAGE2_DETAIL` (по умолчанию: "high") — уровень детализации Vision API OpenAI (765 токенов/изображение, но модель дешевая)
- `STAGE2_MAX_PAGES_PER_REQUEST` (по умолчанию: 30) — максимальное количество страниц в одном запросе (30 × 765 = 22,950 токенов, безопасно для контекстного окна)

### STAGE 3: Детальный анализ
Этап включает детальный анализ релевантных страниц с использованием Vision API. На этой стадии система оценивает соответствие требований проектным решениям с высокой детализацией.

**Функции:**
- Анализ с использованием Vision API
- Оценка соответствия требований проектным решениям
- Группировка требований по общим страницам для оптимизации
- Повторные попытки анализа при отказе модели

**Конфигурационные параметры:**
- `STAGE3_DPI` (по умолчанию: 120) — качество рендеринга (оптимальный баланс: скорость +10%, качество -2%)
- `STAGE3_QUALITY` (по умолчанию: 85) — JPEG качество (повышено для точности, т.к. модель дешевая)
- `STAGE3_DETAIL` (по умолчанию: "high") — уровень детализации Vision API OpenAI (765 токенов/изображение)
- `STAGE3_BATCH_SIZE` (по умолчанию: 10) — количество требований в одном батче (увеличено для дешевой модели - меньше запросов)
- `STAGE3_MAX_COMPLETION_TOKENS` (по умолчанию: 8000) — максимальное количество токенов в ответе (увеличено для больших батчей)
- `STAGE3_RETRY_ON_REFUSAL` (по умолчанию: True) — повторять запрос с батчами размером 1 при отказе модели
- `STAGE3_MAX_PAGES_PER_REQUEST` (по умолчанию: 30) — максимальное количество страниц в одном запросе (30 × 765 = 22,950 токенов < 30,000 TPM)

### STAGE 4: Поиск противоречий
Опциональная стадия, предназначенная для проверки противоречий между различными разделами проекта и оценки критичности выявленных несоответствий. Может быть отключена для ускорения анализа больших проектов.

**Функции:**
- Проверка на противоречия между различными разделами проекта
- Оценка критичности выявленных несоответствий
- Генерация отчета о найденных противоречиях

**Конфигурационные параметры:**
- `STAGE4_ENABLED` (по умолчанию: True) — включить/выключить Stage 4 (отключите для ускорения больших проектов)
- `STAGE4_SAMPLE_PAGES_PER_SECTION` (по умолчанию: 5) — количество страниц из каждого раздела для анализа
- `STAGE4_DPI` (по умолчанию: 100) — качество (среднее между Stage 2 и 3)
- `STAGE4_QUALITY` (по умолчанию: 70) — JPEG качество
- `STAGE4_DETAIL` (по умолчанию: "low") — уровень детализации Vision API OpenAI (экономия токенов)
- `STAGE4_MAX_COMPLETION_TOKENS` (по умолчанию: 6000) — больше токенов для подробного отчета о противоречиях

## Запуск проекта

### Локальный запуск
1. Установите Docker и Docker Compose
2. Создайте файл `.env` в папке `api-service` на основе `.env.example`
3. Добавьте свой API-ключ OpenAI
4. Выполните команду:

```bash
docker-compose up --build
```

### Веб-интерфейс
После запуска веб-интерфейс будет доступен по адресу: `http://localhost:7861`

### API-эндпоинт
API будет доступен по адресу: `http://localhost:8002`

## Конфигурация

### API-сервис (api-service/config.py)
- `OPENAI_MODEL` - модель OpenAI для анализа
- `STAGE1_MAX_PAGES` - максимальное количество страниц для извлечения метаданных
- `STAGE2_MAX_PAGES` - максимальное количество страниц для оценки релевантности
- `STAGE3_BATCH_SIZE` - размер батча для анализа требований
- `STAGE4_ENABLED` - включение/выключение поиска противоречий
- Настройки DPI и качества изображений для оптимизации токенов

### UI-сервис
- `API_SERVICE_URL` - URL для подключения к API-сервису

## Структура проекта

```
doc-analysis-service/
├── api-service/                    # API-сервис на FastAPI
│   ├── analysis_api_hybrid.py     # Основной файл с API-методами
│   ├── config.py                  # Конфигурация системы анализа
│   ├── requirements.txt           # Зависимости Python
│   └── Dockerfile                # Docker-файл для API-сервиса
├── ui-service/                     # UI-сервис на Gradio
│   ├── gradio_ui.py               # Основной файл с интерфейсом
│   ├── requirements.txt           # Зависимости Python
│   └── Dockerfile                # Docker-файл для UI-сервиса
├── prompts/                       # Промпты для различных стадий
│   ├── gk_prompt.txt              # Промпт для ГК
│   ├── fe_prompt.txt              # Промпт для ФЭ
│   ├── ep_prompt.txt              # Промпт для ЭП
│   └── README.md                  # Описание промптов
├── docker-compose.yml             # Оркестрация контейнеров
└── README.md                      # Документация проекта
```

## Промпты и настройки

### Промпты
Система использует специализированные промпты для каждой стадии проектирования:
- `gk_prompt.txt` - для градостроительной концепции
- `fe_prompt.txt` - для форэскизного проекта
- `ep_prompt.txt` - для эскизного проекта

Каждый промпт включает:
- Описание задачи анализа
- Исходные данные для анализа
- Методику анализа
- Критерии оценки
- Дополнительные указания

### Критерии оценки
- **Полностью исполнено**: требование реализовано в полном объёме
- **Частично исполнено**: реализовано не полностью или с отклонениями
- **Не исполнено**: не отражено в проектных решениях
- **Требует уточнения**: недостаточно данных для однозначной оценки

## Схема работы системы

```
┌─────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   Техническое   │    │   Проектная      │    │    Технические   │
│   Задание (ТЗ)  │    │  документация    │    │   Условия (ТУ)   │
│     PDF/DOCX    │    │     PDF/DOCX     │    │     PDF/DOCX     │
└─────────┬───────┘    └─────────┬────────┘    └─────────┬────────┘
          │                      │                       │
          └──────────┬───────────┼───────────────────────┘
                     │           │
         ┌───────────▼───────────▼──────────┐
         │      API-сервис (FastAPI)        │
         │  ┌─────────────────────────────┐ │
         │  │  1. Извлечение метаданных   │ │
         │  │  2. Оценка релевантности    │ │
         │  │  3. Детальный анализ       │ │
         │  │  4. Поиск противоречий     │ │
         │  └─────────────────────────────┘ │
         └──────────┬───────────────────────┘
                    │
        ┌───────────▼───────────┐
        │   Веб-интерфейс      │
        │   (Gradio UI)        │
        │                      │
        │  ┌─────────────────┐ │
        │  │   Результаты    │ │
        │  │   анализа в    │ │
        │  │   табличном    │ │
        │  │   виде         │ │
        │  └─────────────────┘ │
        └──────────────────────┘
```

## Результаты анализа

Система формирует детализированный отчет, включающий:
- Таблицу соответствия требований проектным решениям
- Статус исполнения каждого требования
- Уверенность в определении
- Описание найденных решений
- Ссылки на конкретные страницы/листы
- Выявленные несоответствия
- Рекомендации по устранению

## Безопасность и производительность

- Используется SOCKS-прокси для доступа к OpenAI API
- Реализована защита от превышения лимитов токенов
- Внедрены механизмы повторных попыток при ошибках
- Валидация размера загружаемых файлов (до 40 МБ)
- Поддержка обработки больших документов (до 100+ страниц)

## Ограничения

- Максимальный размер файла: 40 МБ
- Необходим API-ключ OpenAI для работы Vision API
- Требуется стабильное подключение к интернету
- Время анализа зависит от количества страниц и требований

## Вклад в проект

1. Форкните репозиторий
2. Создайте feature-ветку
3. Внесите изменения
4. Протестируйте работоспособность
5. Создайте pull request

## Лицензия

Проект распространяется под [указать лицензию при наличии или удалить этот раздел если лицензия не указана]