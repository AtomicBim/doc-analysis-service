# Система анализа проектной документации

## Описание проекта

Система автоматического анализа строительной документации на соответствие требованиям технического задания (ТЗ) и технических условий (ТУ) с использованием искусственного интеллекта. 

Проект представляет собой гибридное решение, которое:
- Рассматривает ТЗ/ТУ как текстовые документы с последующей сегментацией требований
- Анализирует проектную документацию (чертежи) с помощью Vision API
- Сопоставляет требования с проектными решениями
- Выдает детализированный отчет о соответствии/несоответствии

## Архитектура

Система состоит из двух основных компонентов:

### 1. API-сервис (api-service)
- **Технология**: FastAPI
- **Функция**: Обработка запросов на анализ, интеграция с OpenAI API, выполнение анализа документации
- **Порты**: 8000 (внутри контейнера), 8002 (внешний)

### 2. UI-сервис (ui-service)
- **Технология**: Gradio
- **Функция**: Веб-интерфейс для загрузки документов и отображения результатов
- **Порты**: 7861 (внутри контейнера), 7861 (внешний)

## Технологии

### Backend (api-service)
- **Python 3.11** - основной язык программирования
- **FastAPI** - веб-фреймворк для создания API
- **OpenAI API** - для анализа чертежей с использованием Vision API
- **PyMuPDF** - для работы с PDF-документами
- **Pillow** - для обработки изображений
- **Tenacity** - для повторных попыток при ошибках API
- **Uvicorn** - ASGI-сервер для запуска приложения

### Frontend (ui-service)
- **Python 3.11** - основной язык программирования
- **Gradio** - фреймворк для создания веб-интерфейса
- **Requests** - для взаимодействия с API

### Инфраструктура
- **Docker** - контейнеризация сервисов
- **Docker Compose** - оркестрация контейнеров
- **SOCKS прокси** - для доступа к OpenAI API через VPN

## Принципы работы

### Стадии анализа
Система реализует 4-ступенчатый процесс анализа:

1. **STAGE 1**: Извлечение метаданных страниц
   - Определение типа, раздела и номера листа для каждой страницы
   - Анализ штампов и заголовков документов

2. **STAGE 2**: Оценка релевантности страниц
   - Сопоставление требований с соответствующими страницами документации
   - Выбор минимального набора страниц для анализа

3. **STAGE 3**: Детальный анализ
   - Анализ с использованием Vision API
   - Оценка соответствия требований проектным решениям

4. **STAGE 4**: Поиск противоречий
   - Проверка на противоречия между различными разделами проекта
   - Оценка критичности выявленных несоответствий

### Поддерживаемые стадии проектирования
- **ГК** - Градостроительная концепция
- **ФЭ** - Форэскизный проект
- **ЭП** - Эскизный проект

### Поддерживаемые форматы документов
- **PDF** - для проектной документации
- **DOCX** - для технических заданий и условий

## Запуск проекта

### Локальный запуск
1. Установите Docker и Docker Compose
2. Создайте файл `.env` в папке `api-service` на основе `.env.example`
3. Добавьте свой API-ключ OpenAI
4. Выполните команду:

```bash
docker-compose up --build
```

### Веб-интерфейс
После запуска веб-интерфейс будет доступен по адресу: `http://localhost:7861`

### API-эндпоинт
API будет доступен по адресу: `http://localhost:8002`

## Конфигурация

### API-сервис (api-service/config.py)
- `OPENAI_MODEL` - модель OpenAI для анализа
- `STAGE1_MAX_PAGES` - максимальное количество страниц для извлечения метаданных
- `STAGE2_MAX_PAGES` - максимальное количество страниц для оценки релевантности
- `STAGE3_BATCH_SIZE` - размер батча для анализа требований
- `STAGE4_ENABLED` - включение/выключение поиска противоречий
- Настройки DPI и качества изображений для оптимизации токенов

### UI-сервис
- `API_SERVICE_URL` - URL для подключения к API-сервису

## Структура проекта

```
doc-analysis-service/
├── api-service/                    # API-сервис на FastAPI
│   ├── analysis_api_hybrid.py     # Основной файл с API-методами
│   ├── config.py                  # Конфигурация системы анализа
│   ├── requirements.txt           # Зависимости Python
│   └── Dockerfile                # Docker-файл для API-сервиса
├── ui-service/                     # UI-сервис на Gradio
│   ├── gradio_ui.py               # Основной файл с интерфейсом
│   ├── requirements.txt           # Зависимости Python
│   └── Dockerfile                # Docker-файл для UI-сервиса
├── prompts/                       # Промпты для различных стадий
│   ├── gk_prompt.txt              # Промпт для ГК
│   ├── fe_prompt.txt              # Промпт для ФЭ
│   ├── ep_prompt.txt              # Промпт для ЭП
│   └── README.md                  # Описание промптов
├── docker-compose.yml             # Оркестрация контейнеров
└── README.md                      # Документация проекта
```

## Промпты и настройки

### Промпты
Система использует специализированные промпты для каждой стадии проектирования:
- `gk_prompt.txt` - для градостроительной концепции
- `fe_prompt.txt` - для форэскизного проекта
- `ep_prompt.txt` - для эскизного проекта

Каждый промпт включает:
- Описание задачи анализа
- Исходные данные для анализа
- Методику анализа
- Критерии оценки
- Дополнительные указания

### Критерии оценки
- **Полностью исполнено**: требование реализовано в полном объёме
- **Частично исполнено**: реализовано не полностью или с отклонениями
- **Не исполнено**: не отражено в проектных решениях
- **Требует уточнения**: недостаточно данных для однозначной оценки

## Схема работы системы

```
┌─────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   Техническое   │    │   Проектная      │    │    Технические   │
│   Задание (ТЗ)  │    │  документация    │    │   Условия (ТУ)   │
│     PDF/DOCX    │    │     PDF/DOCX     │    │     PDF/DOCX     │
└─────────┬───────┘    └─────────┬────────┘    └─────────┬────────┘
          │                      │                       │
          └──────────┬───────────┼───────────────────────┘
                     │           │
         ┌───────────▼───────────▼──────────┐
         │      API-сервис (FastAPI)        │
         │  ┌─────────────────────────────┐ │
         │  │  1. Извлечение метаданных   │ │
         │  │  2. Оценка релевантности    │ │
         │  │  3. Детальный анализ       │ │
         │  │  4. Поиск противоречий     │ │
         │  └─────────────────────────────┘ │
         └──────────┬───────────────────────┘
                    │
        ┌───────────▼───────────┐
        │   Веб-интерфейс      │
        │   (Gradio UI)        │
        │                      │
        │  ┌─────────────────┐ │
        │  │   Результаты    │ │
        │  │   анализа в    │ │
        │  │   табличном    │ │
        │  │   виде         │ │
        │  └─────────────────┘ │
        └──────────────────────┘
```

## Результаты анализа

Система формирует детализированный отчет, включающий:
- Таблицу соответствия требований проектным решениям
- Статус исполнения каждого требования
- Уверенность в определении
- Описание найденных решений
- Ссылки на конкретные страницы/листы
- Выявленные несоответствия
- Рекомендации по устранению

## Безопасность и производительность

- Используется SOCKS-прокси для доступа к OpenAI API
- Реализована защита от превышения лимитов токенов
- Внедрены механизмы повторных попыток при ошибках
- Валидация размера загружаемых файлов (до 40 МБ)
- Поддержка обработки больших документов (до 100+ страниц)

## Ограничения

- Максимальный размер файла: 40 МБ
- Необходим API-ключ OpenAI для работы Vision API
- Требуется стабильное подключение к интернету
- Время анализа зависит от количества страниц и требований

## Вклад в проект

1. Форкните репозиторий
2. Создайте feature-ветку
3. Внесите изменения
4. Протестируйте работоспособность
5. Создайте pull request

## Лицензия

Проект распространяется под [указать лицензию при наличии или удалить этот раздел если лицензия не указана]