# Система автоматического анализа проектной документации

## Содержание
1. [Описание проекта](#описание-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Технологии](#технологии)
4. [Запуск системы](#запуск-системы)
5. [Основные модули и их функции](#основные-модули-и-их-функции)
6. [Особенности реализации](#особенности-реализации)
7. [Примеры использования](#примеры-использования)

## Описание проекта

Система автоматического анализа проектной документации - это инновационное решение для автоматической проверки соответствия проектной документации требованиям технического задания (ТЗ) и технических условий (ТУ) с использованием искусственного интеллекта.

Основная цель проекта - автоматизировать процесс анализа объемной строительной документации (чертежей, спецификаций, пояснительных записок) на соответствие требованиям ТЗ/ТУ, что значительно ускоряет процесс проверки проектов и снижает вероятность человеческих ошибок.

Система поддерживает анализ на различных стадиях проектирования:
- **ГК (Градостроительная концепция)** - анализ концептуальных решений
- **ФЭ (Форэскиз)** - анализ предварительных проектных решений
- **ЭП (Эскизный проект)** - анализ эскизных проектных решений

### Основные функции:
- Загрузка ТЗ, проектной документации и ТУ в форматах PDF и DOCX
- Автоматический парсинг требований из ТЗ
- Анализ соответствия проектных решений требованиям ТЗ/ТУ
- Генерация отчетов с оценкой соответствия каждого требования
- Классификация статуса каждого требования (исполнено/частично исполнено/не исполнено/требует уточнения)

## Архитектура системы

Система реализована как микросервисное приложение с использованием Docker и включает два основных компонента:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Пользовательский ИНТЕРФЕЙС                    │
├─────────────────────────────────────────────────────────────────────────┤
│                    [Gradio Web UI - порт 7861]                         │
├─────────────────────────────────────────────────────────────────────────┤
│                   Взаимодействие с API-сервером                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           API-СЕРВИС                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                   [FastAPI - порт 8000]                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  • Анализ требований из ТЗ                                              │
│  • Обработка проектной документации                                     │
│  • Визуальный анализ чертежей через OpenAI Vision API                   │
│  • Интеграция с OpenAI GPT-4                                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ВНЕШНИЕ СЕРВИСЫ                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                    [OpenAI API]                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  • Обработка текста через GPT-4                                        │
│  • Анализ изображений через Vision API                                 │
│  • Генерация оценок и описаний                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Компоненты системы:

1. **UI-сервис (Gradio)**:
   - Веб-интерфейс для загрузки файлов и настройки параметров анализа
   - Пользовательский интерфейс для просмотра результатов
   - Отправка запросов к API-сервису

2. **API-сервис (FastAPI)**:
   - Обработка файлов и извлечение требований
   - Интеграция с OpenAI API для анализа
   - Визуальный анализ чертежей через Vision API
   - Генерация отчетов

### Схема обработки документов:

```
1. Загрузка файлов      ┌─────────────────────────────────────┐
   ├─ ТЗ (Техническое задание)           │  ┌─────────────┐                   │
   ├─ Проектная документация (чертежи)   │  │   FastAPI   │                   │
   └─ ТУ (Технические условия)           │  │   API       │                   │
                                         │  │  Сервер     │                   │
2. Парсинг ТЗ           ┌─────────────┐  │  └─────────────┘                   │
   ├─ Извлечение требований ────────────┼─▶│                                 │
   └─ Классификация      └─────────────┘  │                                 │
                                         │                                 │
3. Анализ чертежей      ┌─────────────┐  │  ┌─────────────────────────────┐  │
   ├─ Извлечение метаданных ────────────┼─▶│  OpenAI GPT-4               │  │
   ├─ Оценка релевантности ─────────────┼─▶│  Vision API                 │  │
   └─ Детальный анализ    └─────────────┘  │                             │  │
                                         │  └─────────────────────────────┘  │
4. Сравнение и оценка   ┌─────────────┐  │                                 │
   ├─ Сопоставление требований ──────────┼──┼─────────────────────────────────┤
   └─ Оценка соответствия  └─────────────┘  │                                 │
                                         │                                 │
5. Генерация отчета     ┌─────────────┐  │  ┌─────────────────────────────┐  │
   ├─ Таблица соответствия ──────────────┼──┼─▶│  Gradio UI                  │  │
   └─ Сводка по проекту    └─────────────┘     │  Интерфейс                   │
                                              └─────────────────────────────┘
```

## Технологии

### Backend (API-сервис):
- **Python 3.11** - основной язык программирования
- **FastAPI** - фреймворк для создания API
- **OpenAI API** - для анализа текста и изображений
- **PyMuPDF (fitz)** - для работы с PDF-документами
- **Pillow** - для обработки изображений
- **Tenacity** - для повторных попыток при ошибках
- **NumPy** - для вычислений

### Frontend (UI-сервис):
- **Gradio** - фреймворк для создания веб-интерфейса
- **Requests** - для HTTP-запросов к API

### Внешние сервисы:
- **OpenAI GPT-4** - для анализа требований и генерации описаний
- **OpenAI Vision API** - для анализа чертежей и графических материалов
- **OpenAI Assistants API** - для специализированного анализа

### Инфраструктура:
- **Docker** - контейнеризация
- **Docker Compose** - оркестрация микросервисов
- **SOCKS прокси** - для доступа к OpenAI API (в корпоративных сетях)

## Запуск системы

### Предварительные требования:
- Docker и Docker Compose
- OpenAI API ключ

### Установка:
1. Клонирование репозитория:
   ```bash
   git clone <repository_url>
   cd doc-analysis-service
   ```

2. Настройка переменных окружения:
   ```bash
   cp api-service/.env.example api-service/.env
   # Отредактируйте api-service/.env и добавьте свой OpenAI API ключ
   ```

3. Запуск через Docker Compose:
   ```bash
   docker-compose up --build -d
   ```

### Доступ к сервисам:
- **UI-интерфейс**: http://localhost:7861
- **API-сервер**: http://localhost:8000

### Важные замечания:
- API-сервис требует доступ к OpenAI API (может использовать SOCKS-прокси)
- UI-сервис может работать в корпоративной сети без прокси
- Максимальный размер загружаемых файлов: 40 МБ

## Основные модули и их функции

### API-сервис (analysis_api_hybrid.py)

#### Функции обработки PDF:
- `extract_pdf_pages_as_images()` - конвертирует PDF-страницы в изображения для Vision API
- `extract_page_metadata()` - извлекает метаданные страниц (штампы, заголовки)
- `extract_text_from_pdf()` - извлекает текст из PDF с поддержкой OCR

#### Функции анализа:
- `segment_requirements()` - сегментирует ТЗ на отдельные требования
- `classify_requirements_into_batches()` - группирует требования по смыслу
- `assess_page_relevance()` - оценивает релевантность страниц для каждого требования
- `analyze_batch_with_high_detail()` - детальный анализ требований с высококачественными изображениями

#### Классы моделей:
- `RequirementAnalysis` - модель результата анализа одного требования
- `AnalysisResponse` - модель ответа API с результатами

#### Эндпоинты:
- `GET /` - проверка работоспособности сервиса
- `POST /analyze` - основной эндпоинт для анализа документации

### UI-сервис (gradio_ui.py)

#### Функции интерфейса:
- `create_interface()` - создание веб-интерфейса с Gradio
- `process_documentation_analysis()` - основная функция обработки запросов
- `call_analysis_api()` - вызов API-сервиса для анализа
- `format_analysis_results()` - форматирование результатов в Markdown

#### Элементы интерфейса:
- Загрузка файлов (ТЗ, проектная документация, ТУ)
- Выбор стадии документации
- Флажок проверки ТУ
- Кнопка запуска анализа
- Отображение результатов в виде таблицы

### Конфигурационный файл (config.py)

Содержит настройки для различных этапов анализа:
- STAGE1 - извлечение метаданных
- STAGE2 - оценка релевантности страниц
- STAGE3 - детальный анализ релевантных страниц
- Параметры OpenAI API
- Настройки логирования

### Папка prompts

Содержит специализированные промпты для разных стадий:
- `gk_prompt.txt` - промпт для Градостроительной концепции
- `fe_prompt.txt` - промпт для Форэскиза
- `ep_prompt.txt` - промпт для Эскизного проекта
- `tu_fe.txt` - типовые технические условия для ФЭ
- `tu_ep.txt` - типовые технические условия для ЭП

## Особенности реализации

### Многоэтапный процесс анализа:
1. **Этап 1 (STAGE 1)**: Извлечение метаданных страниц (штампы, заголовки) через Vision API
2. **Этап 2 (STAGE 2)**: Оценка релевантности страниц для каждого требования
3. **Этап 3 (STAGE 3)**: Детальный анализ требований с высококачественными изображениями

### Экономия токенов OpenAI:
- Использование низкокачественных изображений для предварительной оценки
- Пакетная обработка требований
- Извлечение только релевантных страниц для детального анализа

### Обработка больших документов:
- Разбиение на чанки для избежания лимитов токенов
- Поддержка до 150 страниц в документе
- Автоматическая обработка больших пакетов требований

### Обработка исключительных ситуаций:
- Повторные попытки при ошибках API (retry с экспоненциальным backoff)
- Обработка случаев, когда модель отказывается отвечать
- Обнаружение отключения клиента и корректное завершение анализа

## Примеры использования

### Сценарии использования:

1. **Проверка соответствия проекта требованиям ТЗ**:
   - Загрузка ТЗ и проектной документации
   - Выбор стадии "ФЭ" или "ЭП"
   - Запуск анализа
   - Получение отчета с оценками по каждому требованию

2. **Анализ соответствия ТУ и проектных решений**:
   - Загрузка ТЗ, ТУ и проектной документации
   - Включение опции проверки ТУ
   - Выбор соответствующей стадии
   - Получение комплексного анализа

### Результаты анализа:

Система генерирует подробный отчет с таблицей для каждого требования, содержащей:
- Номер требования
- Текст требования из ТЗ
- Статус исполнения (Полностью исполнено/Частично исполнено/Не исполнено/Требует уточнения)
- Уровень достоверности (в процентах)
- Описание решения в проекте
- Ссылки на конкретные листы/разделы проектной документации
- Выявленные несоответствия
- Рекомендации по улучшению

Также предоставляется сводка по всем требованиям с процентным соотношением выполненных и невыполненных требований.